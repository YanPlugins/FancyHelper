name: CI-Build & Release

#ï¼ï¼ï¼ä¸è¦æŠŠFancyHelperæ”¹æˆfancyhelper

on:
  push:
    tags: [ 'v*' ]
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹ï¼ˆsnapshot-å¿«ç…§åŒ…/release-æ­£å¼åŒ…ï¼‰'
        required: true
        default: 'snapshot'
        type: choice
        options:
          - snapshot
          - release
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å·ï¼ˆä»…releaseç±»å‹ç”Ÿæ•ˆï¼Œæ— éœ€å¸¦vå‰ç¼€ï¼‰'
        required: false
        type: string
      skip_checks:
        description: 'è·³è¿‡æ£€æŸ¥ï¼ˆä»…ç”¨äºç´§æ€¥å‘å¸ƒï¼‰'
        required: false
        default: false
        type: boolean

env:
  MAVEN_OPTS: -Dmaven.repo.local=${{ github.workspace }}/.m2/repository

jobs:
  # ==================== å•å…ƒæµ‹è¯• ====================
  test:
    name: å•å…ƒæµ‹è¯• (Java ${{ matrix.java }})
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_checks) }}
    strategy:
      matrix:
        java: [ 17, 21 ]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: temurin
          cache: maven

      - name: ç¼“å­˜ Maven ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-java${{ matrix.java }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-java${{ matrix.java }}-
            ${{ runner.os }}-maven-

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: mvn -B test

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report-java${{ matrix.java }}
          path: target/surefire-reports/

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.java == 17
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/

  # ==================== æ„å»ºå’Œå‘å¸ƒ ====================
  build:
    name: æ„å»º
    runs-on: ubuntu-latest
    needs: [ test ]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      contents: write
    outputs:
      IS_RELEASE: ${{ steps.check_release.outputs.IS_RELEASE }}
      RELEASE_VERSION: ${{ steps.check_release.outputs.RELEASE_VERSION }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ç¡®å®šå‘å¸ƒç±»å‹
      - name: Determine Release Type
        id: check_release
        run: |
          git fetch origin master --tags
          IS_RELEASE=false
          RELEASE_VERSION=""
          SHORT_SHA="${GITHUB_SHA::7}"

          # æƒ…å†µ1: æ‰‹åŠ¨è§¦å‘-å‘å¸ƒæ­£å¼åŒ…
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.build_type }}" == "release" ]]; then
            echo "Event is workflow_dispatch release"
            IS_RELEASE=true
            if [[ -n "${{ inputs.custom_version }}" ]]; then
              RELEASE_VERSION="${{ inputs.custom_version }}"
            else
              RELEASE_VERSION="$SHORT_SHA"
            fi
            echo "Manual release version: $RELEASE_VERSION"

          # æƒ…å†µ2: Push Tag
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "Event is Push Tag"
            if git branch -r --contains ${{ github.sha }} | grep -q 'origin/master'; then
              IS_RELEASE=true
              RELEASE_VERSION=${GITHUB_REF_NAME#v}
              echo "Tag is on master. Release verified."
            else
              echo "Tag is NOT on master. Skipping release."
            fi

          # æƒ…å†µ3: Push to master
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "Event is Push to master"
            TAG=$(git tag --points-at HEAD | grep '^v' | head -n 1)
            if [[ -n "$TAG" ]]; then
              IS_RELEASE=true
              RELEASE_VERSION=${TAG#v}
              echo "Commit has tag $TAG. Triggering release."
            else
              echo "No release tag found on commit. Triggering pre-release."
            fi
          fi

          echo "IS_RELEASE=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: ç¼“å­˜ Maven ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ç”ŸæˆçŸ­SHAï¼ˆæ‰‹åŠ¨è§¦å‘å¿«ç…§åŒ…ä¹Ÿéœ€è¦ï¼‰
      - name: ç”ŸæˆçŸ­ SHA
        id: sha
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # æ‰‹åŠ¨è§¦å‘-å¿«ç…§åŒ…ç‰ˆæœ¬è®¾ç½®
      - name: æ‰‹åŠ¨è§¦å‘-è®¾ç½®å¿«ç…§ç‰ˆæœ¬
        if: github.event_name == 'workflow_dispatch' && inputs.build_type == 'snapshot'
        run: |
          mvn -B versions:set \
              -DnewVersion=#${{ steps.sha.outputs.SHORT_SHA }} \
              -DgenerateBackupPoms=false

      # åŸæœ‰é€»è¾‘-å¿«ç…§ç‰ˆæœ¬è®¾ç½®ï¼ˆæ’é™¤æ‰‹åŠ¨è§¦å‘åœºæ™¯ï¼‰
      - name: è®¾ç½®å¿«ç…§ç‰ˆæœ¬
        if: (github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/v')) && github.event_name != 'workflow_dispatch'
        run: |
          mvn -B versions:set \
              -DnewVersion=#${{ steps.sha.outputs.SHORT_SHA }} \
              -DgenerateBackupPoms=false

      # æ‰‹åŠ¨è§¦å‘-æ­£å¼åŒ…ç‰ˆæœ¬è®¾ç½®
      - name: æ‰‹åŠ¨è§¦å‘-è®¾ç½®å‘å¸ƒç‰ˆæœ¬
        if: github.event_name == 'workflow_dispatch' && inputs.build_type == 'release'
        run: |
          VERSION=${{ inputs.custom_version || steps.sha.outputs.SHORT_SHA }}
          mvn -B versions:set -DnewVersion="$VERSION" -DgenerateBackupPoms=false

      # åŸæœ‰é€»è¾‘-æ­£å¼ç‰ˆæœ¬è®¾ç½®
      - name: è®¾ç½®å‘å¸ƒç‰ˆæœ¬
        if: steps.check_release.outputs.IS_RELEASE == 'true' && github.event_name != 'workflow_dispatch'
        run: |
          VERSION=${{ steps.check_release.outputs.RELEASE_VERSION }}
          mvn -B versions:set -DnewVersion="$VERSION" -DgenerateBackupPoms=false

      # æ‰‹åŠ¨è§¦å‘-å¿«ç…§åŒ…ç¼–è¯‘æ‰“åŒ…
      - name: æ‰‹åŠ¨è§¦å‘-ç¼–è¯‘æµ‹è¯•&æ‰“åŒ…å¿«ç…§
        if: github.event_name == 'workflow_dispatch' && inputs.build_type == 'snapshot'
        run: mvn -B package

      # åŸæœ‰é€»è¾‘-å¿«ç…§åŒ…ç¼–è¯‘æ‰“åŒ…
      - name: ç¼–è¯‘æµ‹è¯• & æ‰“åŒ…å¿«ç…§
        if: (github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/v')) && github.event_name != 'workflow_dispatch'
        run: mvn -B package

      # æ‰‹åŠ¨è§¦å‘-æ­£å¼åŒ…ç¼–è¯‘æ‰“åŒ…ï¼ˆè·³è¿‡æµ‹è¯•ï¼‰
      - name: æ‰‹åŠ¨è§¦å‘-é‡æ–°æ„å»ºï¼ˆè·³è¿‡æµ‹è¯•ï¼‰
        if: github.event_name == 'workflow_dispatch' && inputs.build_type == 'release'
        run: mvn -B package -DskipTests

      # åŸæœ‰é€»è¾‘-æ­£å¼åŒ…ç¼–è¯‘æ‰“åŒ…
      - name: é‡æ–°æ„å»ºï¼ˆè·³è¿‡æµ‹è¯•ï¼‰
        if: steps.check_release.outputs.IS_RELEASE == 'true' && github.event_name != 'workflow_dispatch'
        run: mvn -B package -DskipTests

      # æ‰‹åŠ¨è§¦å‘-ä¸Šä¼ å¿«ç…§åŒ…
      - name: æ‰‹åŠ¨è§¦å‘-ä¸Šä¼ å¿«ç…§åŒ…
        if: github.event_name == 'workflow_dispatch' && inputs.build_type == 'snapshot'
        uses: actions/upload-artifact@v4
        with:
          name: FancyHelper-manual-snapshot-#${{ steps.sha.outputs.SHORT_SHA }}
          path: target/FancyHelper-*.jar

      # ç”Ÿæˆå®‰å…¨çš„refåç§°
      - name: ç”Ÿæˆå®‰å…¨çš„refåç§°
        id: safe_ref_name
        run: echo "SAFE_REF_NAME=$(echo ${{ github.ref_name }} | sed 's|/|-|g')" >> $GITHUB_OUTPUT

      # åŸæœ‰é€»è¾‘-ä¸Šä¼ å¿«ç…§åŒ…
      - name: ä¸Šä¼ å¿«ç…§åŒ…
        if: (github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/v')) && github.event_name != 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: FancyHelper-${{ steps.safe_ref_name.outputs.SAFE_REF_NAME }}-#${{ steps.sha.outputs.SHORT_SHA }}
          path: target/FancyHelper-*.jar

      # æ‰‹åŠ¨è§¦å‘-ä¸Šä¼ æ­£å¼åŒ…
      - name: æ‰‹åŠ¨è§¦å‘-ä¸Šä¼ æ­£å¼åŒ…
        if: github.event_name == 'workflow_dispatch' && inputs.build_type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: FancyHelper-manual-release-${{ inputs.custom_version || steps.sha.outputs.SHORT_SHA }}
          path: target/FancyHelper-*.jar

      # æ­£å¼Releaseä¸Šä¼ artifact
      - name: ä¸Šä¼ æ­£å¼ReleaseåŒ…
        if: steps.check_release.outputs.IS_RELEASE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: FancyHelper-release-${{ steps.check_release.outputs.RELEASE_VERSION }}
          path: target/FancyHelper-*.jar

  # ==================== AI ç”Ÿæˆå‘è¡Œæ³¨è®° Overview ====================
  generate-overview:
    name: AI ç”Ÿæˆå‘è¡Œæ³¨è®°
    runs-on: ubuntu-latest
    needs: [ build ]
    if: needs.build.outputs.IS_RELEASE == 'true'
    outputs:
      ai_overview: ${{ steps.ai_result.outputs.OVERVIEW }}
      github_notes: ${{ steps.github_notes.outputs.NOTES }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è·å–ç‰ˆæœ¬å·ï¼ˆä»build jobç»§æ‰¿ï¼‰
      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION="${{ needs.build.outputs.RELEASE_VERSION }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # å®‰è£… GitHub CLI
      - name: å®‰è£… GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      # è·å–ä¸Šæ¬¡ Release çš„ tag
      - name: è·å–ä¸Šæ¬¡ Release Tag
        id: last_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "ä¸Šæ¬¡ Release Tag: $LAST_TAG"

      # è·å–è‡ªä¸Šæ¬¡ tag ä»¥æ¥çš„ commits
      - name: è·å– Commits å˜åŒ–
        id: commits
        run: |
          if [[ -n "${{ steps.last_tag.outputs.LAST_TAG }}" ]]; then
            COMMITS=$(git log ${{ steps.last_tag.outputs.LAST_TAG }}..HEAD --pretty=format:"%s (%h)" 2>/dev/null || echo "æ— ")
          else
            # æ²¡æœ‰ä¸Šæ¬¡tagï¼Œè·å–æ‰€æœ‰commits
            COMMITS=$(git log --pretty=format:"%s (%h)" -20 2>/dev/null || echo "æ— ")
          fi
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Commits: $COMMITS"

      # è·å–ä»“åº“ä¿¡æ¯
      - name: è·å–ä»“åº“ä¿¡æ¯
        id: repo_info
        run: |
          echo "REPO_NAME=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "REPO_OWNER=${{ github.repository_owner }}" >> $GITHUB_OUTPUT

      # è°ƒç”¨ CloudFlare AI ç”Ÿæˆ Overview
      - name: è°ƒç”¨ AI ç”Ÿæˆå‘è¡Œæ³¨è®° Overview
        id: ai_result
        run: |
          # è·å– account-id
          ACCOUNT_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_KEY }}" \
            "https://api.cloudflare.com/client/v4/accounts" | jq -r '.result[0].id')
          
          if [[ -z "$ACCOUNT_ID" || "$ACCOUNT_ID" == "null" ]]; then
            echo "æ— æ³•è·å– CloudFlare Account IDï¼Œä½¿ç”¨é»˜è®¤Overview"
            echo "OVERVIEW=## ğŸš€ ç‰ˆæœ¬æ¦‚è¿°\n\næœ¬æ¬¡æ›´æ–°åŒ…å«å¤šé¡¹åŠŸèƒ½æ”¹è¿›å’Œé—®é¢˜ä¿®å¤ã€‚" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ„å»º prompt
          VERSION="${{ steps.version.outputs.VERSION }}"
          COMMITS="${{ steps.commits.outputs.COMMITS }}"
          
          PROMPT="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç‰ˆæœ¬å‘å¸ƒåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹ Git commits ä¿¡æ¯ï¼Œä¸º FancyHelper Minecraft æ’ä»¶ç”Ÿæˆä¸€æ®µä¸­æ–‡çš„å‘è¡Œæ³¨è®° Overviewï¼ˆç®€æ´æ‘˜è¦ï¼‰ã€‚\n\nç‰ˆæœ¬å·: v$VERSION\n\nCommits åˆ—è¡¨:\n$COMMITS\n\nè¦æ±‚ï¼š\n1. ç”¨ä¸­æ–‡æ’°å†™\n2. ç®€æ´æ˜äº†ï¼Œæ§åˆ¶åœ¨ 100-200 å­—\n3. çªå‡ºä¸»è¦åŠŸèƒ½æ›´æ–°ã€bugä¿®å¤å’Œé‡è¦æ”¹åŠ¨\n4. ä½¿ç”¨ emoji å¢åŠ å¯è¯»æ€§\n5. ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦æœ‰å¼€åœºç™½\n6. ä½¿ç”¨ Markdown æ ¼å¼ï¼Œä»¥ ## ğŸš€ ç‰ˆæœ¬æ¦‚è¿° å¼€å¤´\n\nè¯·ç”Ÿæˆå‘è¡Œæ³¨è®° Overviewï¼š"
          
          # è°ƒç”¨ CloudFlare AI API
          RESPONSE=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/ai/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\
              \"model\": \"@cf/openai/gpt-oss-120b\",\n\
              \"messages\": [\n                {\"role\": \"system\", \"content\": \"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç‰ˆæœ¬å‘å¸ƒåŠ©æ‰‹ï¼Œæ“…é•¿æ’°å†™ç®€æ´æ˜äº†çš„ä¸­æ–‡å‘è¡Œæ³¨è®°ã€‚\"},\n                {\"role\": \"user\", \"content\": \"$PROMPT\"}\n              ],\n              \"max_tokens\": 500\n            }")
          
          # è§£æ AI å“åº”
          OVERVIEW=$(echo "$RESPONSE" | jq -r '.result.response // .result.message.content // ""' 2>/dev/null)
          
          if [[ -z "$OVERVIEW" || "$OVERVIEW" == "null" ]]; then
            echo "AI å“åº”ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤Overview"
            echo "OVERVIEW=## ğŸš€ ç‰ˆæœ¬æ¦‚è¿°\n\næœ¬æ¬¡æ›´æ–°åŒ…å«å¤šé¡¹åŠŸèƒ½æ”¹è¿›å’Œé—®é¢˜ä¿®å¤ã€‚" >> $GITHUB_OUTPUT
          else
            # è½¬ä¹‰ JSON å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            OVERVIEW_ESCAPED=$(echo "$OVERVIEW" | jq -Rs '.')
            echo "OVERVIEW=$OVERVIEW_ESCAPED" >> $GITHUB_OUTPUT
            echo "AI Overview ç”ŸæˆæˆåŠŸ"
            echo "$OVERVIEW"
          fi

      # è·å– GitHub è‡ªåŠ¨ç”Ÿæˆçš„ Release Notes
      - name: è·å– GitHub Release Notes
        id: github_notes
        run: |
          # ä½¿ç”¨ GitHub API ç”Ÿæˆ release notes
          NOTES=$(gh api \
            "repos/${{ github.repository }}/releases/generate-notes" \
            -f tag_name="v${{ steps.version.outputs.VERSION }}" \
            -f target_commitish="${{ github.sha }}" \
            --jq '.body' 2>/dev/null || echo "")
          
          if [[ -z "$NOTES" ]]; then
            NOTES="æš‚æ— è¯¦ç»†å‘è¡Œè¯´æ˜"
          fi
          
          # è½¬ä¹‰å¹¶è¾“å‡º
          NOTES_ESCAPED=$(echo "$NOTES" | jq -Rs '.')
          echo "NOTES=$NOTES_ESCAPED" >> $GITHUB_OUTPUT
          echo "GitHub Release Notes è·å–æˆåŠŸ"

  # ==================== å‘å¸ƒæ­£å¼ Release ====================
  release:
    name: å‘å¸ƒ Release
    runs-on: ubuntu-latest
    needs: [ build, generate-overview ]
    if: needs.build.outputs.IS_RELEASE == 'true'
    permissions:
      contents: write
    steps:
      # åˆ¤æ–­artifactåç§°ï¼ˆç®€åŒ–é€»è¾‘ï¼šç›´æ¥æŸ¥æ‰¾åŒ¹é…çš„æœ€æ–°artifactï¼‰
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: FancyHelper-*
          path: target/
          merge-multiple: true

      - name: å‘å¸ƒæ­£å¼ Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: target/FancyHelper-*.jar
          tag_name: v${{ needs.build.outputs.RELEASE_VERSION }}
          name: Release v${{ needs.build.outputs.RELEASE_VERSION }}
          target_commitish: ${{ github.sha }}
          body: ${{ needs.generate-overview.outputs.ai_overview }}${{ needs.generate-overview.outputs.github_notes }}
          make_latest: true
